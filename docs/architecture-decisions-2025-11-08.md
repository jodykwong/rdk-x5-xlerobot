# XleRobot 架构决策记录

**文档日期**: 2025-11-08
**版本**: v2.0 (简化架构版本)
**记录者**: BMad Master
**项目**: XleRobot Brownfield Level 4 重新初始化

---

## 🎯 关键架构决策概述

### 决策1: 从复杂本地处理转向纯API集成 (2025-11-08)

**背景:**
- 原项目包含100,197行严重过度工程化代码
- 存在大量不必要的本地音频处理、模型训练、复杂优化
- 偏离了"快速验证用户需求"的迭代目标

**决策:**
- **迭代1**: 完全依赖阿里云API服务 (ASR + TTS + 唤醒词)
- **删除**: 所有本地复杂处理模块
- **保留**: 基础音频采集和API调用能力

**影响:**
- 代码量从100,197行目标减少到~700行 (迭代1)
- 开发周期从不确定缩短到3-4周
- 维护复杂度显著降低
- 依赖云端服务，但迭代2将引入本地处理

**实施状态:**
- ✅ 已删除21,726行过度工程化代码
- ✅ 重新规划Story 1.1和1.2
- 🔄 仍需继续清理剩余~77,771行代码

---

### 决策2: 三迭代渐进式架构确认 (2025-11-08)

**背景:**
- 用户明确要求三迭代架构定义
- 需要平衡快速验证与长期目标

**决策:**

#### 迭代1: 纯在线服务 (3-4周)
- **目标**: 快速验证用户需求
- **技术栈**: 阿里云API + ROS2 + Python 3.10
- **代码量**: ~700行
- **核心功能**: 基础语音交互

#### 迭代2: 离线AI服务 (6-8周)
- **目标**: 建立本地AI处理能力
- **技术栈**: SenseVoiceSmall + Qwen2.5-0.5B + FastSpeech2
- **代码量**: ~2,300行
- **核心功能**: 隐私保护的本地处理

#### 迭代3: 集成XleRobot (8-10周)
- **目标**: 完整智能机器人系统
- **技术栈**: 视觉感知 + 机械臂控制 + 自主导航
- **代码量**: ~4,200行
- **核心功能**: 完整家用机器人

**影响:**
- 清晰的技术演进路线
- 风险可控的渐进式开发
- 每个迭代都交付用户价值

---

### 决策3: 硬件约束驱动设计 (2025-11-08)

**背景:**
- D-Robotics RDK X5硬件限制 (ARM Cortex-A55, 6.1GB可用内存)
- 实时性要求 (机械臂控制 <100ms响应)
- 嵌入式开发环境约束

**决策:**
- **严格硬件约束**: 所有设计必须考虑ARM架构和内存限制
- **实时性优先**: 机械臂控制优先级最高
- **开发环境固定**: 强制ROS2 Humble + Python 3.10

**影响:**
- 模型选择受限 (轻量级模型优先)
- 架构设计必须考虑资源优化
- 不能随意引入重型依赖

---

## 🔄 废弃的架构决策

### 废弃决策: 复杂本地音频处理管道
**原因**: 过度工程化，违反快速验证原则
**替代方案**: 简单音频采集 + 阿里云API

### 废弃决策: 本地唤醒词训练系统
**原因**: 811行不必要的复杂实现
**替代方案**: 阿里云唤醒词API

### 废弃决策: 企业级扩展性和监控系统
**原因**: Level 4项目不需要过度企业化设计
**替代方案**: 基础监控和日志

---

## 📊 当前架构状态

### ✅ 已实现的组件
- 基础ROS2 + Python 3.10环境
- 阿里云ASR服务集成 (需简化)
- 阿里云TTS服务集成 (需清理重复实现)
- 令牌管理系统

### 🔄 需要简化的组件
- `aliyun_asr_service.py` (582行 → 目标200行)
- TTS模块多个重复实现 (需要合并)
- 系统控制模块过度企业化设计

### ❌ 已删除的过度工程化组件
- 健康检查系统 (1,015行)
- 扩展性管理器 (851行)
- 个性化引擎 (899行×3)
- 本地唤醒词训练器 (811行)
- 复杂音频增强处理 (840行)

---

## 🎯 架构原则和约束

### 核心原则
1. **简单优先**: 避免过度工程化
2. **价值导向**: 每个迭代都交付用户价值
3. **硬件约束**: 严格遵守嵌入式环境限制
4. **渐进式演进**: 从简单到复杂的技术路线

### 技术约束
- **语言**: Python 3.10 (强制)
- **框架**: ROS2 Humble (强制)
- **硬件**: D-Robotics RDK X5
- **内存**: 可用6.1GB
- **实时性**: <100ms机械臂控制响应

### 禁止的模式
- ❌ 复杂的本地音频处理算法
- ❌ 企业级架构模式 (Level 4项目不需要)
- ❌ 重复的功能实现
- ❌ 未经验证的第三方库
- ❌ 过度优化的性能调优

---

## 📋 下一步架构工作

### 立即执行 (本周)
1. 继续简化剩余过度工程化代码
2. 实现Story 1.1简化版本
3. 更新架构图反映简化设计

### 短期目标 (2周)
1. 完成迭代1所有Stories
2. 验证纯API集成方案可行性
3. 准备迭代2本地模型集成规划

### 长期目标 (2-3个月)
1. 完成三迭代架构演进
2. 建立稳定的本地+云端混合架构
3. 优化性能以满足实时性要求

---

## 🔍 架构质量指标

### 代码质量目标
- **迭代1代码量**: <700行
- **代码重复率**: <5%
- **函数平均长度**: <30行
- **圈复杂度**: <10

### 性能目标
- **语音交互延迟**: <500ms
- **机械臂控制延迟**: <100ms
- **内存使用**: <4GB (运行时)
- **CPU使用率**: <50% (空闲时)

### 可维护性目标
- **文档覆盖率**: >90%
- **测试覆盖率**: >80%
- **依赖数量**: <20个核心依赖
- **构建时间**: <2分钟

---

_记录完成: 2025-11-08_
_下次评审: 迭代1完成后_
_架构负责人: BMad Master_