# Epic1 系统架构澄清记录

**文档编号**: XLR-EPIC1-ARCH-20251114-001
**项目名称**: XleRobot 家用机器人控制系统
**Epic ID**: Epic 1 - 多模态语音交互服务
**创建日期**: 2025-11-14
**重要性**: 关键架构决策记录

---

## 📋 Epic1 架构模式确认

### ✅ 核心架构原则
**Epic1 采用纯在线服务模式，不存在任何本地模型或离线使用方式。**

### 🔌 在线服务依赖

#### 1. 阿里云NLS语音服务 (100%在线)
- **ASR服务**: 阿里云语音识别 (WebSocket)
- **TTS服务**: 阿里云语音合成 (HTTPS REST API)
- **认证方式**: 阿里云Token认证
- **依赖**: 全天候网络连接

#### 2. 通义千问LLM服务 (100%在线)
- **LLM提供商**: 阿里云通义千问
- **模型**: qwen3-vl-plus (多模态版本)
- **调用方式**: API调用
- **依赖**: 全天候网络连接

#### 3. 无本地AI模型
- ❌ 无本地ASR模型
- ❌ 无本地TTS模型
- ❌ 无本地LLM模型
- ❌ 无离线语音处理能力

### 🌐 网络依赖特性

#### 必需的网络连接
- **阿里云NLS服务**: wss://nls-gateway.cn-shanghai.aliyuncs.com/ws/v1
- **阿里云TTS服务**: https://nls-gateway.cn-shanghai.aliyuncs.com/stream/v1/tts
- **通义千问API**: 阿里云API网关

#### 故障模式
- **网络中断**: 系统完全不可用
- **API服务故障**: 对应功能完全失效
- **无离线降级**: 不存在备用本地方案

---

## 🎯 当前问题诊断

### 问题根源分析
**事件**: 系统播放"打电话给10086"等不相关回应内容

**根本原因**:
1. **ASR误识别**: 用户说"傻强" → 阿里云ASR识别为"打电话给10086"等内容
2. **唤醒词逻辑缺陷**: 过于宽泛的正则表达式 `r'^打電話畀[零一二三四五六七八九十0-9一二三四五六七八九十]+$'`
3. **上下文污染**: ASR误识别内容被传递给通义千问LLM，生成不相关回应

### 技术分析
- **不是本地模型问题**: 全部在线服务，本地只做音频采集和播放
- **不是代码库污染**: 检查确认无硬编码的不当内容
- **不是API劫持**: 连接正确的阿里云服务
- **是逻辑设计缺陷**: 唤醒词检测机制过于宽泛

---

## 🔧 修复策略

### 立即修复
1. **收紧唤醒词检测模式**
   - 当前: 接受所有"打電話畀[数字]"模式
   - 修复: 只接受经过验证的特定误识别模式

2. **模式白名单化**
   ```python
   # 修复前 (过于宽泛)
   phone_pattern = r'^打電話畀[零一二三四五六七八九十0-9一二三四五六七八九十]+$'

   # 修复后 (严格白名单)
   valid_wake_patterns = [
       r'^打電話畀一二$',      # 经过验证的ASR误识别模式
       r'^打電話畀1\s*2$',    # 数字版本
   ]
   ```

3. **上下文隔离**
   - 避免唤醒词识别内容污染后续LLM对话
   - 清晰区分唤醒阶段和指令阶段

### 长期优化
1. **多模态验证** - 结合音频特征和ASR结果
2. **用户确认机制** - 唤醒后要求用户确认
3. **自学习优化** - 根据用户反馈调整检测参数

---

## 📊 系统特性总结

| 特性 | 状态 | 说明 |
|------|------|------|
| **架构模式** | ✅ 纯在线 | 100%依赖阿里云服务 |
| **ASR服务** | ✅ 在线 | 阿里云NLS WebSocket |
| **TTS服务** | ✅ 在线 | 阿里云NLS HTTPS API |
| **LLM服务** | ✅ 在线 | 通义千问qwen3-vl-plus |
| **离线能力** | ❌ 无 | 网络中断即完全不可用 |
| **本地模型** | ❌ 无 | 无任何本地AI模型 |
| **故障降级** | ❌ 无 | 无备用方案 |

---

## 🎯 关键技术决策记录

1. **选择在线架构**: 为了获得最佳的粤语语音识别效果和多模态能力
2. **不接受离线方案**: 本地模型无法达到阿里云服务的粤语识别准确率
3. **接受网络依赖**: 作为产品架构的必要权衡
4. **专注在线优化**: 所有技术优化都围绕在线服务进行

---

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-11-14 | 初始架构澄清记录 | BMad Master |
| | | 明确Epic1纯在线架构特性 | |
| | | 记录当前问题的根本原因 | |

---

## 🔗 相关文档

- [阿里云NLS WebSocket连接指南](./aliyun-nls-websocket-connection-guide.md)
- [ASR服务技术规格文档](./asr-service-technical-specification.md)
- [Epic 1语音交互系统设计](./epics-phase2-xlerobot.md)

---

**文档状态**: ✅ 已完成
**架构确认**: ✅ Epic1纯在线服务模式
**问题定位**: ✅ 唤醒词检测逻辑缺陷
**修复方向**: ✅ 收紧检测模式 + 上下文隔离

---

*本文档明确记录Epic1的纯在线架构特性，作为技术决策和问题诊断的重要参考。*