# XLeRobot WebSocketé€šä¿¡ä¸è§†è§‰äº¤äº’è¡¥å……æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-16
**é€‚ç”¨ç‰ˆæœ¬**: Epic 1 (çº¯åœ¨çº¿æ¶æ„)
**è¡¥å……å†…å®¹**: WebSocketé€šä¿¡æ¶æ„ + è§†è§‰äº¤äº’æµç¨‹

---

## ğŸ“‹ ç›®å½•

1. [WebSocketé€šä¿¡æ¶æ„](#1-websocketé€šä¿¡æ¶æ„)
2. [è§†è§‰äº¤äº’å®Œæ•´æµç¨‹](#2-è§†è§‰äº¤äº’å®Œæ•´æµç¨‹)
3. [å¤šæ¨¡æ€äº¤äº’åœºæ™¯](#3-å¤šæ¨¡æ€äº¤äº’åœºæ™¯)
4. [å®Œæ•´æ•°æ®æµç¤ºä¾‹](#4-å®Œæ•´æ•°æ®æµç¤ºä¾‹)

---

## âš ï¸ é‡è¦è¯´æ˜

æœ¬æ–‡æ¡£è¡¥å……äº†ä¸»æ¶æ„æ–‡æ¡£ä¸­ç¼ºå°‘çš„ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ï¼š

1. **ASR/TTSä½¿ç”¨WebSocketé€šä¿¡**ï¼Œè€ŒéREST API
2. **è§†è§‰äº¤äº’æµç¨‹**ï¼Œç³»ç»Ÿæ”¯æŒè¯­éŸ³+è§†è§‰å¤šæ¨¡æ€äº¤äº’

---

## 1. WebSocketé€šä¿¡æ¶æ„

### 1.1 ä¸ºä»€ä¹ˆä½¿ç”¨WebSocketï¼Ÿ

é˜¿é‡Œäº‘NLSæœåŠ¡**å¿…é¡»ä½¿ç”¨WebSocketåè®®**ï¼ŒHTTP REST APIæ— æ³•æ­£å¸¸å·¥ä½œã€‚

**WebSocketä¼˜åŠ¿**:
- âœ… æ”¯æŒ**æµå¼å¤„ç†**ï¼šå®æ—¶è¯­éŸ³è¯†åˆ«å’Œåˆæˆ
- âœ… æ”¯æŒ**åŒå‘é€šä¿¡**ï¼šå¯ä»¥æ¥æ”¶ä¸­é—´ç»“æœ
- âœ… é™ä½**å»¶è¿Ÿ**ï¼šé¿å…HTTPè¯·æ±‚/å“åº”å¼€é”€
- âœ… æ”¯æŒ**é•¿éŸ³é¢‘**ï¼šå¯ä»¥æŒç»­ä¼ è¾“éŸ³é¢‘æµ

### 1.2 ASR WebSocketè¿æ¥

#### è¿æ¥ä¿¡æ¯

```yaml
WebSocketç«¯ç‚¹: wss://nls-gateway.cn-shanghai.aliyuncs.com/ws/v1
åè®®: WebSocket
è®¤è¯æ–¹å¼: Token (é€šè¿‡SDKè‡ªåŠ¨å¤„ç†)
SDK: aliyun-nls-python-sdk
æ ¸å¿ƒç±»: NlsSpeechRecognizer
```

#### è¿æ¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          é˜¿é‡Œäº‘ASR WebSocketè¿æ¥å®Œæ•´æµç¨‹                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬1æ­¥: Tokenè·å–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ä½¿ç”¨AccessKeyè·å–Token             â”‚
â”‚    from nls.token import getToken     â”‚
â”‚    token = getToken(key_id, secret)   â”‚
â”‚                                      â”‚
â”‚ 2. Tokenæœ‰æ•ˆæœŸ: 24å°æ—¶                â”‚
â”‚ 3. è‡ªåŠ¨åˆ·æ–°æœºåˆ¶: æå‰30åˆ†é’Ÿåˆ·æ–°        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
ç¬¬2æ­¥: WebSocketè¿æ¥å»ºç«‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åˆ›å»ºNlsSpeechRecognizerå®ä¾‹        â”‚
â”‚    recognizer = NlsSpeechRecognizer(  â”‚
â”‚        token=token,                   â”‚
â”‚        appkey=app_key,                â”‚
â”‚        on_start=callback,             â”‚
â”‚        on_result_changed=callback,    â”‚
â”‚        on_completed=callback,         â”‚
â”‚        on_error=callback              â”‚
â”‚    )                                  â”‚
â”‚                                      â”‚
â”‚ 2. è¿æ¥åˆ°WSSç«¯ç‚¹                      â”‚
â”‚    wss://nls-gateway.cn-shanghai      â”‚
â”‚    .aliyuncs.com/ws/v1                â”‚
â”‚                                      â”‚
â”‚ 3. æ¡æ‰‹è®¤è¯ (SDKè‡ªåŠ¨å®Œæˆ)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
ç¬¬3æ­¥: éŸ³é¢‘æµä¼ è¾“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. éŸ³é¢‘æ ¼å¼è¦æ±‚:                      â”‚
â”‚    - æ ¼å¼: PCM                        â”‚
â”‚    - é‡‡æ ·ç‡: 16000 Hz                 â”‚
â”‚    - ä½æ·±: 16-bit                     â”‚
â”‚    - å£°é“: å•å£°é“ (mono)              â”‚
â”‚                                      â”‚
â”‚ 2. å¼€å§‹è¯†åˆ«                           â”‚
â”‚    recognizer.start(                  â”‚
â”‚        aformat="pcm",                 â”‚
â”‚        sample_rate=16000,             â”‚
â”‚        enable_intermediate_result=Trueâ”‚
â”‚    )                                  â”‚
â”‚                                      â”‚
â”‚ 3. å‘é€éŸ³é¢‘æ•°æ®                       â”‚
â”‚    recognizer.send_audio(audio_data)  â”‚
â”‚    (å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼Œæµå¼å‘é€)           â”‚
â”‚                                      â”‚
â”‚ 4. ç»“æŸè¯†åˆ«                           â”‚
â”‚    recognizer.stop()                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
ç¬¬4æ­¥: æ¥æ”¶è¯†åˆ«ç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. on_start() - è¯†åˆ«å¼€å§‹              â”‚
â”‚    æ—¥å¿—: "ğŸ¤ è¯†åˆ«å¼€å§‹"                 â”‚
â”‚                                      â”‚
â”‚ 2. on_result_changed() - ä¸­é—´ç»“æœ     â”‚
â”‚    {                                 â”‚
â”‚      "header": {...},                â”‚
â”‚      "payload": {                    â”‚
â”‚        "index": 1,                   â”‚
â”‚        "time": 1000,                 â”‚
â”‚        "result": "ä»Šæ—¥"               â”‚
â”‚      }                                â”‚
â”‚    }                                 â”‚
â”‚                                      â”‚
â”‚ 3. on_completed() - æœ€ç»ˆç»“æœ          â”‚
â”‚    {                                 â”‚
â”‚      "header": {...},                â”‚
â”‚      "payload": {                    â”‚
â”‚        "result": "ä»Šæ—¥å¤©æ°”ç‚¹æ ·",       â”‚
â”‚        "confidence": 95.2            â”‚
â”‚      }                                â”‚
â”‚    }                                 â”‚
â”‚                                      â”‚
â”‚ 4. on_error() - é”™è¯¯å¤„ç†              â”‚
â”‚    å¤„ç†è¿æ¥é”™è¯¯ã€è¶…æ—¶ã€æ ¼å¼é”™è¯¯ç­‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä»£ç å®ç°ç¤ºä¾‹

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""é˜¿é‡Œäº‘ASR WebSocketè¿æ¥ç¤ºä¾‹"""

import sys
sys.path.append('/home/sunrise/.local/lib/python3.10/site-packages')

from nls.token import getToken
from nls.speech_recognizer import NlsSpeechRecognizer
import json

class AliyunASRWebSocket:
    """é˜¿é‡Œäº‘ASR WebSocketè¿æ¥å™¨"""

    def __init__(self, access_key_id, access_key_secret, app_key):
        self.access_key_id = access_key_id
        self.access_key_secret = access_key_secret
        self.app_key = app_key
        self.token = None
        self.recognizer = None
        self.result_text = ""

    def get_token(self):
        """è·å–Token"""
        self.token = getToken(self.access_key_id, self.access_key_secret)
        print(f"âœ… Tokenè·å–æˆåŠŸ: {self.token[:20]}...")
        return self.token

    def on_start(self, message, *args):
        """è¯†åˆ«å¼€å§‹å›è°ƒ"""
        print("ğŸ¤ ASRè¯†åˆ«å¼€å§‹")

    def on_result_changed(self, message, *args):
        """ä¸­é—´ç»“æœå›è°ƒ"""
        try:
            result = json.loads(message)
            if 'payload' in result and 'result' in result['payload']:
                text = result['payload']['result']
                print(f"ğŸ”„ ä¸­é—´ç»“æœ: {text}")
        except Exception as e:
            print(f"âŒ ä¸­é—´ç»“æœè§£æå¤±è´¥: {e}")

    def on_completed(self, message, *args):
        """è¯†åˆ«å®Œæˆå›è°ƒ"""
        try:
            result = json.loads(message)
            if 'payload' in result and 'result' in result['payload']:
                self.result_text = result['payload']['result']
                confidence = result['payload'].get('confidence', 0)
                print(f"âœ… æœ€ç»ˆç»“æœ: '{self.result_text}' (ç½®ä¿¡åº¦: {confidence}%)")
        except Exception as e:
            print(f"âŒ æœ€ç»ˆç»“æœè§£æå¤±è´¥: {e}")

    def on_error(self, message, *args):
        """é”™è¯¯å›è°ƒ"""
        print(f"âŒ ASRé”™è¯¯: {message}")

    def create_recognizer(self):
        """åˆ›å»ºè¯†åˆ«å™¨"""
        if not self.token:
            self.get_token()

        self.recognizer = NlsSpeechRecognizer(
            token=self.token,
            appkey=self.app_key,
            on_start=self.on_start,
            on_result_changed=self.on_result_changed,
            on_completed=self.on_completed,
            on_error=self.on_error
        )
        print("âœ… ASR WebSocketè¿æ¥å™¨åˆ›å»ºæˆåŠŸ")
        return self.recognizer

    def recognize_audio(self, audio_file_path):
        """è¯†åˆ«éŸ³é¢‘æ–‡ä»¶"""
        import wave

        # åˆ›å»ºè¯†åˆ«å™¨
        if not self.recognizer:
            self.create_recognizer()

        # è¯»å–éŸ³é¢‘æ–‡ä»¶
        with wave.open(audio_file_path, 'rb') as wav_file:
            audio_data = wav_file.readframes(wav_file.getnframes())

        # å¼€å§‹è¯†åˆ«
        self.recognizer.start(
            aformat="pcm",
            sample_rate=16000,
            enable_intermediate_result=True
        )

        # å‘é€éŸ³é¢‘æ•°æ®
        self.recognizer.send_audio(audio_data)

        # ç»“æŸè¯†åˆ«
        self.recognizer.stop()

        # ç­‰å¾…ç»“æœ
        import time
        timeout = 10
        start_time = time.time()
        while not self.result_text and (time.time() - start_time) < timeout:
            time.sleep(0.1)

        return self.result_text

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    asr = AliyunASRWebSocket(
        access_key_id="LTAI5tQ4E2YNzZkGn9g1JqeY",
        access_key_secret="Hr1xZdcdz3D9OgFnH1nvWz5rldXVeI",
        app_key="4G5BCMccTCW8nC8w"
    )

    result = asr.recognize_audio("test_audio.wav")
    print(f"è¯†åˆ«ç»“æœ: {result}")
```

### 1.3 TTS WebSocketè¿æ¥

#### è¿æ¥ä¿¡æ¯

```yaml
WebSocketç«¯ç‚¹: wss://nls-gateway.cn-shanghai.aliyuncs.com/ws/v1
åè®®: WebSocket
è®¤è¯æ–¹å¼: Token (ä¸ASRå…±ç”¨)
SDK: aliyun-nls-python-sdk
æ ¸å¿ƒç±»: NlsSpeechSynthesizer
```

#### è¿æ¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          é˜¿é‡Œäº‘TTS WebSocketè¿æ¥å®Œæ•´æµç¨‹                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬1æ­¥: ä½¿ç”¨ç›¸åŒToken
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tokenå¤ç”¨ASR Token                    â”‚
â”‚ (ASRå’ŒTTSå…±ç”¨åŒä¸€ä¸ªToken Manager)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
ç¬¬2æ­¥: WebSocketè¿æ¥å»ºç«‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åˆ›å»ºNlsSpeechSynthesizerå®ä¾‹       â”‚
â”‚    synthesizer = NlsSpeechSynthesizer(â”‚
â”‚        token=token,                   â”‚
â”‚        appkey=app_key,                â”‚
â”‚        on_start=callback,             â”‚
â”‚        on_audio_data=callback,        â”‚
â”‚        on_completed=callback,         â”‚
â”‚        on_error=callback              â”‚
â”‚    )                                  â”‚
â”‚                                      â”‚
â”‚ 2. è¿æ¥åˆ°WSSç«¯ç‚¹ (ä¸ASRç›¸åŒ)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
ç¬¬3æ­¥: å‘é€æ–‡æœ¬
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è®¾ç½®åˆæˆå‚æ•°                       â”‚
â”‚    synthesizer.start(                 â”‚
â”‚        voice="jiajia",  # ç²¤è¯­éŸ³è‰²    â”‚
â”‚        aformat="wav",                 â”‚
â”‚        sample_rate=16000,             â”‚
â”‚        volume=50,                     â”‚
â”‚        speech_rate=0,  # è¯­é€Ÿæ­£å¸¸     â”‚
â”‚        text="ä»Šæ—¥å¤©æ°”æ™´æœ—"             â”‚
â”‚    )                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
ç¬¬4æ­¥: æ¥æ”¶éŸ³é¢‘æµ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. on_audio_data() - éŸ³é¢‘æ•°æ®æµ       â”‚
â”‚    æŒç»­æ¥æ”¶éŸ³é¢‘ç‰‡æ®µ                    â”‚
â”‚    å¯è¾¹æ¥æ”¶è¾¹æ’­æ”¾ (æµå¼æ’­æ”¾)           â”‚
â”‚                                      â”‚
â”‚ 2. on_completed() - åˆæˆå®Œæˆ          â”‚
â”‚    æ‰€æœ‰éŸ³é¢‘æ•°æ®æ¥æ”¶å®Œæ¯•                â”‚
â”‚                                      â”‚
â”‚ 3. on_error() - é”™è¯¯å¤„ç†              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### TTSä»£ç ç¤ºä¾‹

```python
from nls.speech_synthesizer import NlsSpeechSynthesizer

class AliyunTTSWebSocket:
    """é˜¿é‡Œäº‘TTS WebSocketè¿æ¥å™¨"""

    def __init__(self, token, app_key):
        self.token = token
        self.app_key = app_key
        self.audio_data = bytearray()

    def on_start(self, message, *args):
        """åˆæˆå¼€å§‹å›è°ƒ"""
        print("ğŸµ TTSåˆæˆå¼€å§‹")

    def on_audio_data(self, data, *args):
        """éŸ³é¢‘æ•°æ®å›è°ƒ - æµå¼æ¥æ”¶"""
        self.audio_data.extend(data)
        print(f"ğŸ“¥ æ¥æ”¶éŸ³é¢‘æ•°æ®: {len(data)} å­—èŠ‚")

    def on_completed(self, message, *args):
        """åˆæˆå®Œæˆå›è°ƒ"""
        print(f"âœ… TTSåˆæˆå®Œæˆï¼Œæ€»è®¡ {len(self.audio_data)} å­—èŠ‚")

    def on_error(self, message, *args):
        """é”™è¯¯å›è°ƒ"""
        print(f"âŒ TTSé”™è¯¯: {message}")

    def synthesize(self, text):
        """åˆæˆè¯­éŸ³"""
        self.audio_data = bytearray()

        synthesizer = NlsSpeechSynthesizer(
            token=self.token,
            appkey=self.app_key,
            on_start=self.on_start,
            on_audio_data=self.on_audio_data,
            on_completed=self.on_completed,
            on_error=self.on_error
        )

        synthesizer.start(
            voice="jiajia",  # ç²¤è¯­ä½³ä½³éŸ³è‰²
            aformat="wav",
            sample_rate=16000,
            volume=50,
            speech_rate=0,
            text=text
        )

        # ç­‰å¾…åˆæˆå®Œæˆ
        import time
        timeout = 30
        start_time = time.time()
        while len(self.audio_data) == 0 and (time.time() - start_time) < timeout:
            time.sleep(0.1)

        return bytes(self.audio_data)
```

### 1.4 WebSocketè¿æ¥ç®¡ç†

#### è¿æ¥çŠ¶æ€ç›‘æ§

```python
class WebSocketConnectionManager:
    """WebSocketè¿æ¥ç®¡ç†å™¨"""

    def __init__(self):
        self.asr_connected = False
        self.tts_connected = False
        self.last_asr_ping = 0
        self.last_tts_ping = 0

    def check_health(self):
        """æ£€æŸ¥è¿æ¥å¥åº·çŠ¶æ€"""
        import time
        current_time = time.time()

        # ASRè¿æ¥æ£€æŸ¥
        if current_time - self.last_asr_ping > 60:
            print("âš ï¸ ASR WebSocketè¿æ¥å¯èƒ½å·²æ–­å¼€")
            return False

        # TTSè¿æ¥æ£€æŸ¥
        if current_time - self.last_tts_ping > 60:
            print("âš ï¸ TTS WebSocketè¿æ¥å¯èƒ½å·²æ–­å¼€")
            return False

        return True

    def reconnect_if_needed(self):
        """å¿…è¦æ—¶é‡æ–°è¿æ¥"""
        if not self.check_health():
            print("ğŸ”„ æ£€æµ‹åˆ°è¿æ¥é—®é¢˜ï¼Œæ­£åœ¨é‡æ–°è¿æ¥...")
            # é‡æ–°åˆ›å»ºrecognizerå’Œsynthesizerå®ä¾‹
```

---

## 2. è§†è§‰äº¤äº’å®Œæ•´æµç¨‹

### 2.1 è§†è§‰ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  XLeRobotè§†è§‰äº¤äº’ç³»ç»Ÿ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¡¬ä»¶å±‚          è½¯ä»¶å±‚(ROS2)         äº‘ç«¯æœåŠ¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IMX219   â”‚â”€â”€â”€â†’â”‚ camera     â”‚â”€â”€â”€â†’â”‚ ä¸´æ—¶æ–‡ä»¶å­˜å‚¨     â”‚
â”‚ æ‘„åƒå¤´    â”‚    â”‚ driver     â”‚    â”‚ /tmp/*.jpg      â”‚
â”‚ 1080p    â”‚    â”‚            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ 30fps    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                   â”‚
                        â”‚ ROS2 Topic         â”‚
                        â”‚ /camera/image_raw  â”‚
                        â–¼                   â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ vision_llm_    â”‚â”€â”€â”€â†’â”‚  Qwen-VL API   â”‚
                â”‚ node           â”‚    â”‚  (HTTP/2)      â”‚
                â”‚                â”‚    â”‚  dashscope.    â”‚
                â”‚ - å›¾åƒç¼“å­˜     â”‚    â”‚  aliyuncs.com  â”‚
                â”‚ - ä¼šè¯ç®¡ç†     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ - ä¸Šä¸‹æ–‡å¤„ç†   â”‚              â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                        â”‚                       â”‚
                        â”‚ /vision/query         â”‚
                        â”‚ (ç”¨æˆ·è§†è§‰é—®é¢˜)         â”‚
                        â”‚                       â”‚
                        â”‚ /vision/response      â”‚
                        â”‚ (è§†è§‰ç†è§£ç»“æœ)         â”‚
                        â–¼                       â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ coordinator    â”‚    â”‚ Qwen3-VL-Plus  â”‚
                â”‚                â”‚    â”‚ å¤šæ¨¡æ€æ¨¡å‹     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                â”‚
                                     â”‚ - å›¾åƒç†è§£     â”‚
                                     â”‚ - åœºæ™¯æè¿°     â”‚
                                     â”‚ - ç‰©ä½“è¯†åˆ«     â”‚
                                     â”‚ - ç²¤è¯­å›å¤     â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ‘„åƒå¤´æ•°æ®æµ

#### æ‘„åƒå¤´å¯åŠ¨æµç¨‹

```bash
# 1. æ£€æŸ¥æ‘„åƒå¤´è®¾å¤‡
ls /dev/video*
# è¾“å‡º: /dev/video0 /dev/video1

# 2. æŸ¥çœ‹æ‘„åƒå¤´ä¿¡æ¯
v4l2-ctl --list-devices
# è¾“å‡º:
# IMX219 Camera (platform:rkisp0-vir0):
#     /dev/video0
#     /dev/video1

# 3. å¯åŠ¨ROS2æ‘„åƒå¤´é©±åŠ¨
ros2 run v4l2_camera v4l2_camera_node \
    --ros-args \
    -p video_device:=/dev/video0 \
    -p image_size:="[1920,1080]" \
    -p camera_frame_id:=camera_link \
    -p pixel_format:=YUYV
```

#### å›¾åƒæ¶ˆæ¯æ ¼å¼

```python
# ROS2 sensor_msgs/Image æ¶ˆæ¯ç»“æ„
{
    "header": {
        "stamp": {
            "sec": 1699999999,
            "nanosec": 123456789
        },
        "frame_id": "camera_link"
    },
    "height": 1080,
    "width": 1920,
    "encoding": "bgr8",  # OpenCV BGRæ ¼å¼
    "is_bigendian": 0,
    "step": 5760,  # 1920 * 3 (æ¯åƒç´ 3å­—èŠ‚)
    "data": [...]  # åŸå§‹å›¾åƒæ•°æ®
}
```

### 2.3 è§†è§‰LLMèŠ‚ç‚¹å®ç°

#### æ ¸å¿ƒåŠŸèƒ½

```python
#!/usr/bin/env python3.10
"""è§†è§‰LLMèŠ‚ç‚¹ - å®Œæ•´å®ç°"""

import rclpy
from rclpy.node import Node
from sensor_msgs.msg import Image
from std_msgs.msg import String
from cv_bridge import CvBridge
import cv2
import tempfile

class VisionLLMNode(Node):
    """è§†è§‰LLM ROS2èŠ‚ç‚¹"""

    def __init__(self):
        super().__init__('vision_llm_node')

        # æ ¸å¿ƒç»„ä»¶
        self.bridge = CvBridge()
        self.current_image_path = None
        self.vision_client = QwenVLPlusClient()

        # è®¢é˜…æ‘„åƒå¤´å›¾åƒ
        self.image_sub = self.create_subscription(
            Image,
            '/camera/image_raw',
            self.image_callback,
            10
        )

        # è®¢é˜…è§†è§‰æŸ¥è¯¢
        self.query_sub = self.create_subscription(
            String,
            '/vision/query',
            self.query_callback,
            10
        )

        # å‘å¸ƒè§†è§‰å“åº”
        self.response_pub = self.create_publisher(
            String,
            '/vision/response',
            10
        )

        self.get_logger().info("âœ… è§†è§‰LLMèŠ‚ç‚¹å¯åŠ¨æˆåŠŸ")

    def image_callback(self, msg):
        """æ¥æ”¶å¹¶ç¼“å­˜æœ€æ–°å›¾åƒ"""
        try:
            # è½¬æ¢ROSå›¾åƒä¸ºOpenCVæ ¼å¼
            cv_image = self.bridge.imgmsg_to_cv2(msg, "bgr8")

            # ä¿å­˜ä¸´æ—¶æ–‡ä»¶
            if self.current_image_path:
                os.remove(self.current_image_path)

            temp_file = tempfile.NamedTemporaryFile(
                suffix='.jpg',
                delete=False
            )
            cv2.imwrite(temp_file.name, cv_image)
            self.current_image_path = temp_file.name

            self.get_logger().debug(f"ğŸ“¸ å›¾åƒå·²æ›´æ–°: {self.current_image_path}")

        except Exception as e:
            self.get_logger().error(f"å›¾åƒå¤„ç†å¤±è´¥: {e}")

    def query_callback(self, msg):
        """å¤„ç†è§†è§‰æŸ¥è¯¢"""
        if not self.current_image_path:
            self.get_logger().warn("âš ï¸ æ²¡æœ‰å¯ç”¨å›¾åƒ")
            response = String()
            response.data = "é”™è¯¯ï¼šæ²¡æœ‰å¯ç”¨å›¾åƒï¼Œè¯·å…ˆæ‹æ‘„ç…§ç‰‡"
            self.response_pub.publish(response)
            return

        try:
            # è°ƒç”¨Qwen-VL API
            result = self.vision_client.query(
                image_path=self.current_image_path,
                question=msg.data
            )

            # å‘å¸ƒç»“æœ
            response = String()
            response.data = result
            self.response_pub.publish(response)

            self.get_logger().info(f"âœ… è§†è§‰æŸ¥è¯¢æˆåŠŸ: {msg.data}")

        except Exception as e:
            self.get_logger().error(f"è§†è§‰æŸ¥è¯¢å¤±è´¥: {e}")
```

### 2.4 Qwen-VL APIé›†æˆ

#### APIè°ƒç”¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Qwen-VL APIè°ƒç”¨å®Œæ•´æµç¨‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬1æ­¥: å›¾åƒé¢„å¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯»å–æœ¬åœ°å›¾åƒæ–‡ä»¶                   â”‚
â”‚ 2. Base64ç¼–ç                         â”‚
â”‚ 3. æ„å»ºå›¾åƒURL                        â”‚
â”‚    - æœ¬åœ°è·¯å¾„: file:///path/to/img   â”‚
â”‚    - æˆ–base64: data:image/jpeg;...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
ç¬¬2æ­¥: æ„å»ºAPIè¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST https://dashscope.aliyuncs.com   â”‚
â”‚      /compatible-mode/v1/chat/        â”‚
â”‚      completions                      â”‚
â”‚                                      â”‚
â”‚ Headers:                              â”‚
â”‚   Authorization: Bearer $QWEN_API_KEY â”‚
â”‚   Content-Type: application/json      â”‚
â”‚                                      â”‚
â”‚ Body:                                 â”‚
â”‚ {                                     â”‚
â”‚   "model": "qwen3-vl-plus",           â”‚
â”‚   "messages": [                       â”‚
â”‚     {                                 â”‚
â”‚       "role": "user",                 â”‚
â”‚       "content": [                    â”‚
â”‚         {                             â”‚
â”‚           "type": "image_url",        â”‚
â”‚           "image_url": {              â”‚
â”‚             "url": "base64_or_path"   â”‚
â”‚           }                            â”‚
â”‚         },                            â”‚
â”‚         {                             â”‚
â”‚           "type": "text",             â”‚
â”‚           "text": "å‘¢ä¸ªç³»å’©åšŸå˜…ï¼Ÿ"     â”‚
â”‚         }                             â”‚
â”‚       ]                               â”‚
â”‚     }                                 â”‚
â”‚   ]                                   â”‚
â”‚ }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
ç¬¬3æ­¥: æ¥æ”¶å“åº”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                                     â”‚
â”‚   "id": "chatcmpl-123",               â”‚
â”‚   "object": "chat.completion",        â”‚
â”‚   "created": 1699999999,              â”‚
â”‚   "model": "qwen3-vl-plus",           â”‚
â”‚   "choices": [                        â”‚
â”‚     {                                 â”‚
â”‚       "index": 0,                     â”‚
â”‚       "message": {                    â”‚
â”‚         "role": "assistant",          â”‚
â”‚         "content": "å‘¢ä¸ªç³»ä¸€æ¯å’–å•¡..."â”‚
â”‚       },                              â”‚
â”‚       "finish_reason": "stop"         â”‚
â”‚     }                                 â”‚
â”‚   ],                                  â”‚
â”‚   "usage": {                          â”‚
â”‚     "prompt_tokens": 150,             â”‚
â”‚     "completion_tokens": 30,          â”‚
â”‚     "total_tokens": 180               â”‚
â”‚   }                                   â”‚
â”‚ }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Qwen-VLå®¢æˆ·ç«¯ä»£ç 

```python
import os
import base64
import requests
from typing import Optional

class QwenVLPlusClient:
    """Qwen3-VL-Plus å¤šæ¨¡æ€APIå®¢æˆ·ç«¯"""

    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key or os.getenv("QWEN_API_KEY")
        self.endpoint = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions"
        self.model = "qwen3-vl-plus"

    def encode_image(self, image_path: str) -> str:
        """å°†å›¾åƒç¼–ç ä¸ºBase64"""
        with open(image_path, "rb") as image_file:
            encoded = base64.b64encode(image_file.read()).decode('utf-8')
            return f"data:image/jpeg;base64,{encoded}"

    def query(self, image_path: str, question: str, system_prompt: Optional[str] = None) -> str:
        """
        æŸ¥è¯¢è§†è§‰æ¨¡å‹

        Args:
            image_path: å›¾åƒæ–‡ä»¶è·¯å¾„
            question: ç”¨æˆ·é—®é¢˜
            system_prompt: ç³»ç»Ÿæç¤ºï¼ˆå¯é€‰ï¼‰

        Returns:
            æ¨¡å‹å›å¤æ–‡æœ¬
        """
        # ç¼–ç å›¾åƒ
        image_url = self.encode_image(image_path)

        # æ„å»ºæ¶ˆæ¯
        messages = []

        # ç³»ç»Ÿæç¤º
        if system_prompt:
            messages.append({
                "role": "system",
                "content": system_prompt
            })
        else:
            messages.append({
                "role": "system",
                "content": "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„ç²¤è¯­è¯­éŸ³åŠ©æ‰‹ï¼Œè´Ÿè´£ç†è§£å›¾åƒå¹¶ç”¨ç²¤è¯­å›ç­”é—®é¢˜ã€‚"
            })

        # ç”¨æˆ·æ¶ˆæ¯ï¼ˆå›¾åƒ+æ–‡æœ¬ï¼‰
        messages.append({
            "role": "user",
            "content": [
                {
                    "type": "image_url",
                    "image_url": {
                        "url": image_url
                    }
                },
                {
                    "type": "text",
                    "text": question
                }
            ]
        })

        # APIè¯·æ±‚
        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }

        payload = {
            "model": self.model,
            "messages": messages
        }

        response = requests.post(
            self.endpoint,
            headers=headers,
            json=payload,
            timeout=30
        )

        response.raise_for_status()

        # è§£æå“åº”
        result = response.json()
        return result['choices'][0]['message']['content']
```

---

## 3. å¤šæ¨¡æ€äº¤äº’åœºæ™¯

### 3.1 çº¯è¯­éŸ³äº¤äº’åœºæ™¯

```
ç”¨æˆ·: "å‚»å¼º"  (å”¤é†’è¯)
ç³»ç»Ÿ: "å‚»å¼ºç³»åº¦,è€ç»†æœ‰ä¹œå¯ä»¥å¸®åˆ°ä½ !"  (æ¬¢è¿è¯­)

ç”¨æˆ·: "ä»Šæ—¥å¤©æ°”ç‚¹æ ·ï¼Ÿ"
ç³»ç»Ÿ:
  1. ASRè¯†åˆ« (WebSocket) â†’ "ä»Šæ—¥å¤©æ°”ç‚¹æ ·"
  2. LLMæ¨ç† (HTTP/2) â†’ "ä»Šæ—¥å¹¿å·å¤©æ°”æ™´æœ—..."
  3. TTSåˆæˆ (WebSocket) â†’ éŸ³é¢‘æµ
  4. æ’­æ”¾éŸ³é¢‘

æ—¶é—´çº¿:
T+0.0s: ç”¨æˆ·è¯´"å‚»å¼º"
T+0.5s: ASRæ£€æµ‹åˆ°å”¤é†’è¯
T+0.5s: æ’­æ”¾æ¬¢è¿è¯­
T+2.5s: æ¬¢è¿è¯­æ’­æ”¾å®Œæˆ
T+2.5s: å¼€å§‹ç›‘å¬ç”¨æˆ·æŒ‡ä»¤
T+3.0s: ç”¨æˆ·è¯´"ä»Šæ—¥å¤©æ°”ç‚¹æ ·"
T+4.0s: ASRè¯†åˆ«å®Œæˆ
T+4.0s: å‘é€LLMè¯·æ±‚
T+6.0s: LLMå“åº”è¿”å›
T+6.0s: å‘é€TTSè¯·æ±‚
T+7.0s: TTSåˆæˆå®Œæˆ
T+7.0s: å¼€å§‹æ’­æ”¾å›å¤
T+10.0s: æ’­æ”¾å®Œæˆ
```

### 3.2 è¯­éŸ³+è§†è§‰äº¤äº’åœºæ™¯

```
ç”¨æˆ·: "å‚»å¼º"
ç³»ç»Ÿ: "å‚»å¼ºç³»åº¦,è€ç»†æœ‰ä¹œå¯ä»¥å¸®åˆ°ä½ !"

ç”¨æˆ·: "å‘¢ä¸ªç³»å’©åšŸå˜…ï¼Ÿ"  (æŒ‡ç€æ¡Œä¸Šçš„ç‰©å“)
ç³»ç»Ÿ:
  1. ASRè¯†åˆ« â†’ "å‘¢ä¸ªç³»å’©åšŸå˜…"
  2. æ£€æµ‹åˆ°è§†è§‰æŸ¥è¯¢å…³é”®è¯ ("å‘¢ä¸ª", "å’©åšŸå˜…")
  3. è·å–æœ€æ–°æ‘„åƒå¤´å›¾åƒ
  4. å‘é€åˆ°Qwen-VL API (å›¾åƒ+é—®é¢˜)
  5. æ¥æ”¶è§†è§‰ç†è§£ç»“æœ â†’ "å‘¢ä¸ªç³»ä¸€æ¯å’–å•¡ï¼Œæ”¾å–ºæ¡Œé¢ä¸Š..."
  6. TTSåˆæˆå¹¶æ’­æ”¾

æ—¶é—´çº¿:
T+0.0s: ç”¨æˆ·è¯´"å‚»å¼º"
T+0.5s: å”¤é†’æˆåŠŸ
T+2.5s: ç”¨æˆ·è¯´"å‘¢ä¸ªç³»å’©åšŸå˜…"
T+3.5s: ASRè¯†åˆ«å®Œæˆ
T+3.5s: æ£€æµ‹è§†è§‰æŸ¥è¯¢ï¼Œè§¦å‘æ‘„åƒå¤´
T+3.6s: å‘é€å›¾åƒåˆ°Qwen-VL API
T+5.6s: Qwen-VLå“åº”è¿”å›
T+5.6s: TTSåˆæˆ
T+6.6s: æ’­æ”¾å›å¤
```

### 3.3 è¿ç»­å¤šæ¨¡æ€äº¤äº’

```
å¯¹è¯ç¤ºä¾‹:

å›åˆ1 (çº¯è¯­éŸ³):
ç”¨æˆ·: "å‚»å¼ºï¼Œä½ å¥½å‘€"
ç³»ç»Ÿ: "ä½ å¥½ï¼æˆ‘ç³»å‚»å¼ºï¼Œæœ‰å’©å¯ä»¥å¸®åˆ°ä½ ï¼Ÿ"

å›åˆ2 (è§†è§‰):
ç”¨æˆ·: "ç‡ä¸‹å‘¢å¼ ç›¸ç‰‡"
ç³»ç»Ÿ: "å¥½å˜…ï¼Œæˆ‘ç‡åˆ°ä¸€å¼ ç›¸ç‰‡... (æè¿°å›¾åƒå†…å®¹)"

å›åˆ3 (å¸¦ä¸Šä¸‹æ–‡çš„è§†è§‰):
ç”¨æˆ·: "ç›¸ç‰‡å…¥é¢æœ‰å‡ å¤šä¸ªäººï¼Ÿ"
ç³»ç»Ÿ: "æœ‰ä¸‰ä¸ªäººå–ºåº¦..."

å›åˆ4 (çº¯è¯­éŸ³):
ç”¨æˆ·: "è°¢è°¢ä½ "
ç³»ç»Ÿ: "å””ä½¿å®¢æ°”ï¼"

ä¸Šä¸‹æ–‡ç®¡ç†:
- åè°ƒå™¨ç»´æŠ¤å¯¹è¯å†å²
- è§†è§‰LLMèŠ‚ç‚¹ç»´æŠ¤å›¾åƒä¸Šä¸‹æ–‡
- æ”¯æŒå¤šè½®å¯¹è¯å¼•ç”¨
```

---

## 4. å®Œæ•´æ•°æ®æµç¤ºä¾‹

### 4.1 å¤šæ¨¡æ€æŸ¥è¯¢å®Œæ•´æµç¨‹

```
åœºæ™¯: ç”¨æˆ·é—®"å‘¢æ¯å’–å•¡ç³»å’©é¢œè‰²ï¼Ÿ"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å¤šæ¨¡æ€æŸ¥è¯¢å®Œæ•´æ•°æ®æµ (å¸¦æ—¶é—´æˆ³)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T+0.0s - ç”¨æˆ·è¯­éŸ³è¾“å…¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¯´è¯: "å‘¢æ¯å’–å•¡ç³»å’©é¢œè‰²ï¼Ÿ"         â”‚
â”‚ éº¦å…‹é£é‡‡é›†: 16kHz PCMéŸ³é¢‘æµ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
T+1.0s - ASR WebSocketè¯†åˆ«
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ASRèŠ‚ç‚¹æ¥æ”¶éŸ³é¢‘                    â”‚
â”‚ 2. å‘é€åˆ°WebSocketè¿æ¥                â”‚
â”‚ 3. ä¸­é—´ç»“æœ: "å‘¢æ¯..."                â”‚
â”‚ 4. æœ€ç»ˆç»“æœ: "å‘¢æ¯å’–å•¡ç³»å’©é¢œè‰²"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ /voice_command
T+1.2s - åè°ƒå™¨å¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ¥æ”¶ASRæ–‡æœ¬                        â”‚
â”‚ 2. åˆ†ææŸ¥è¯¢ç±»å‹                       â”‚
â”‚ 3. æ£€æµ‹åˆ°è§†è§‰å…³é”®è¯: "å‘¢æ¯"ã€"é¢œè‰²"   â”‚
â”‚ 4. å†³å®šä½¿ç”¨å¤šæ¨¡æ€æ¨¡å¼                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚           â”‚
           â–¼           â–¼
T+1.3s    è·å–å›¾åƒ    æ„å»ºæŸ¥è¯¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è®¢é˜…        â”‚  â”‚ 1. å‡†å¤‡é—®é¢˜    â”‚
â”‚  /camera/      â”‚  â”‚    æ–‡æœ¬         â”‚
â”‚   image_raw    â”‚  â”‚                â”‚
â”‚ 2. è·å–æœ€æ–°å¸§   â”‚  â”‚ 2. å‡†å¤‡ä¸Šä¸‹æ–‡   â”‚
â”‚ 3. ä¿å­˜ä¸´æ—¶æ–‡ä»¶ â”‚  â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚           â”‚
           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                 â–¼
T+1.5s - å‘é€åˆ°Qwen-VL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP/2 POST to dashscope.aliyuncs.com â”‚
â”‚                                      â”‚
â”‚ Request:                              â”‚
â”‚ {                                     â”‚
â”‚   "model": "qwen3-vl-plus",           â”‚
â”‚   "messages": [                       â”‚
â”‚     {                                 â”‚
â”‚       "role": "user",                 â”‚
â”‚       "content": [                    â”‚
â”‚         {"type": "image_url", ...},   â”‚
â”‚         {"type": "text",              â”‚
â”‚          "text": "å‘¢æ¯å’–å•¡ç³»å’©é¢œè‰²ï¼Ÿ"} â”‚
â”‚       ]                               â”‚
â”‚     }                                 â”‚
â”‚   ]                                   â”‚
â”‚ }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
T+3.5s - Qwen-VLå¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‘ç«¯å¤šæ¨¡æ€æ¨¡å‹å¤„ç†:                    â”‚
â”‚ 1. å›¾åƒç‰¹å¾æå–                       â”‚
â”‚ 2. æ–‡æœ¬è¯­ä¹‰ç†è§£                       â”‚
â”‚ 3. è·¨æ¨¡æ€ç†è§£                         â”‚
â”‚ 4. ç”Ÿæˆç²¤è¯­å›å¤                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
T+3.7s - æ¥æ”¶VLå“åº”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response:                             â”‚
â”‚ {                                     â”‚
â”‚   "choices": [{                       â”‚
â”‚     "message": {                      â”‚
â”‚       "content": "å‘¢æ¯å’–å•¡ç³»å•¡è‰²å˜…ï¼Œ   â”‚
â”‚                   è¡¨é¢æœ‰å¥¶æ³¡..."      â”‚
â”‚     }                                 â”‚
â”‚   }]                                  â”‚
â”‚ }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ /llm_response
T+3.8s - TTS WebSocketåˆæˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. TTSèŠ‚ç‚¹æ¥æ”¶æ–‡æœ¬                    â”‚
â”‚ 2. å»ºç«‹WebSocketè¿æ¥                  â”‚
â”‚ 3. å‘é€æ–‡æœ¬: "å‘¢æ¯å’–å•¡ç³»å•¡è‰²å˜…..."     â”‚
â”‚ 4. æµå¼æ¥æ”¶éŸ³é¢‘æ•°æ®                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
T+4.8s - éŸ³é¢‘æ’­æ”¾
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ’­æ”¾åˆæˆè¯­éŸ³                       â”‚
â”‚ 2. æŒç»­çº¦2-3ç§’                        â”‚
â”‚ 3. æ’­æ”¾å®Œæˆï¼Œè¿”å›ç›‘å¬æ¨¡å¼             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»å»¶è¿Ÿ: ~5ç§’ (ä»ç”¨æˆ·è¯´å®Œåˆ°ç³»ç»Ÿå¼€å§‹å›å¤)
```

### 4.2 ROS2æ¶ˆæ¯æµè¿½è¸ª

```bash
# ç›‘æ§æ‰€æœ‰ROS2è¯é¢˜
ros2 topic list

# è¾“å‡º:
/camera/image_raw          # æ‘„åƒå¤´å›¾åƒ
/voice_command             # ASRè¯†åˆ«ç»“æœ
/vision/query              # è§†è§‰æŸ¥è¯¢
/vision/response           # è§†è§‰å“åº”
/llm_request               # LLMè¯·æ±‚
/llm_response              # LLMå“åº”
/tts_request               # TTSè¯·æ±‚
/system_status             # ç³»ç»ŸçŠ¶æ€

# å®æ—¶ç›‘æ§ç‰¹å®šè¯é¢˜
ros2 topic echo /voice_command    # æŸ¥çœ‹è¯­éŸ³å‘½ä»¤
ros2 topic echo /vision/response  # æŸ¥çœ‹è§†è§‰å“åº”
ros2 topic echo /system_status    # æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€

# æŸ¥çœ‹æ¶ˆæ¯é¢‘ç‡
ros2 topic hz /camera/image_raw   # åº”è¯¥æ˜¯ ~30Hz (30fps)
```

---

## 5. æ•…éšœæ’æŸ¥

### 5.1 WebSocketè¿æ¥é—®é¢˜

```bash
# é—®é¢˜1: ASR WebSocketè¿æ¥å¤±è´¥
ç—‡çŠ¶: æ—¥å¿—æ˜¾ç¤º "WebSocket connection failed"

æ’æŸ¥:
1. æ£€æŸ¥Tokenæ˜¯å¦æœ‰æ•ˆ
   python3.10 -c "
   from aliyun_nls_token_manager import get_valid_token
   print(get_valid_token())
   "

2. æ£€æŸ¥ç½‘ç»œè¿æ¥
   ping nls-gateway.cn-shanghai.aliyuncs.com

3. æ£€æŸ¥SDKå®‰è£…
   pip3.10 list | grep aliyun

4. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
   grep "WebSocket" ~/xlerobot/logs/*.log
```

### 5.2 è§†è§‰æœåŠ¡é—®é¢˜

```bash
# é—®é¢˜2: æ‘„åƒå¤´æ— å›¾åƒ
ç—‡çŠ¶: /camera/image_raw æ— æ¶ˆæ¯å‘å¸ƒ

æ’æŸ¥:
1. æ£€æŸ¥æ‘„åƒå¤´è®¾å¤‡
   ls /dev/video*
   v4l2-ctl --list-devices

2. æ£€æŸ¥ROS2èŠ‚ç‚¹
   ros2 node list | grep camera

3. æµ‹è¯•æ‘„åƒå¤´
   v4l2-ctl --device=/dev/video0 --stream-mmap --stream-count=1

4. é‡å¯æ‘„åƒå¤´èŠ‚ç‚¹
   ros2 run v4l2_camera v4l2_camera_node
```

### 5.3 å¤šæ¨¡æ€æŸ¥è¯¢å¤±è´¥

```bash
# é—®é¢˜3: Qwen-VL APIè°ƒç”¨å¤±è´¥
ç—‡çŠ¶: è§†è§‰æŸ¥è¯¢è¿”å›é”™è¯¯

æ’æŸ¥:
1. æ£€æŸ¥APIå¯†é’¥
   echo $QWEN_API_KEY

2. æµ‹è¯•APIè¿æ¥
   curl -X POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions \
     -H "Authorization: Bearer $QWEN_API_KEY" \
     -H "Content-Type: application/json" \
     -d '{"model":"qwen-plus","messages":[{"role":"user","content":"ä½ å¥½"}]}'

3. æ£€æŸ¥å›¾åƒç¼–ç 
   python3.10 -c "
   import base64
   with open('test.jpg', 'rb') as f:
       encoded = base64.b64encode(f.read())
       print(f'Image size: {len(encoded)} bytes')
   "

4. æŸ¥çœ‹è¯¦ç»†é”™è¯¯
   grep "Qwen-VL" ~/xlerobot/logs/*.log
```

---

## 6. æ€§èƒ½æŒ‡æ ‡

### 6.1 WebSocketæ€§èƒ½

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | è¯´æ˜ |
|------|--------|--------|------|
| ASRè¿æ¥å»ºç«‹æ—¶é—´ | < 500ms | ~300ms | é¦–æ¬¡è¿æ¥ |
| ASRæµå¼å»¶è¿Ÿ | < 200ms | ~150ms | å®æ—¶è¯†åˆ«å»¶è¿Ÿ |
| TTSè¿æ¥å»ºç«‹æ—¶é—´ | < 500ms | ~300ms | é¦–æ¬¡è¿æ¥ |
| TTSæµå¼å»¶è¿Ÿ | < 300ms | ~200ms | é¦–ç‰‡éŸ³é¢‘è¿”å› |
| WebSocketå¿ƒè·³é—´éš” | 30s | 30s | ä¿æŒè¿æ¥æ´»è·ƒ |

### 6.2 è§†è§‰å¤„ç†æ€§èƒ½

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | è¯´æ˜ |
|------|--------|--------|------|
| æ‘„åƒå¤´å¸§ç‡ | 30fps | 30fps | 1080påˆ†è¾¨ç‡ |
| å›¾åƒæ•è·å»¶è¿Ÿ | < 50ms | ~33ms | å•å¸§è·å–æ—¶é—´ |
| Qwen-VLæ¨ç†å»¶è¿Ÿ | < 3s | 2-3s | å›¾åƒç†è§£æ—¶é—´ |
| ç«¯åˆ°ç«¯è§†è§‰æŸ¥è¯¢ | < 5s | 4-5s | ä»é—®é¢˜åˆ°å›å¤ |

### 6.3 å¤šæ¨¡æ€äº¤äº’æ€§èƒ½

| åœºæ™¯ | ç›®æ ‡å»¶è¿Ÿ | å®é™…å»¶è¿Ÿ | ç“¶é¢ˆ |
|------|---------|---------|------|
| çº¯è¯­éŸ³äº¤äº’ | < 5s | 4-5s | LLMæ¨ç† |
| è¯­éŸ³+è§†è§‰äº¤äº’ | < 8s | 6-8s | VLæ¨ç† |
| è¿ç»­å¯¹è¯ | < 3s | 2-3s | ä¸Šä¸‹æ–‡ç®¡ç† |

---

## 7. æœ€ä½³å®è·µ

### 7.1 WebSocketè¿æ¥ç®¡ç†

```python
# æœ€ä½³å®è·µ1: è¿æ¥æ± ç®¡ç†
class WebSocketPool:
    """WebSocketè¿æ¥æ± """

    def __init__(self, max_connections=5):
        self.max_connections = max_connections
        self.asr_pool = []
        self.tts_pool = []

    def get_asr_connection(self):
        """è·å–ASRè¿æ¥"""
        if len(self.asr_pool) < self.max_connections:
            # åˆ›å»ºæ–°è¿æ¥
            conn = create_asr_websocket()
            self.asr_pool.append(conn)
            return conn
        else:
            # å¤ç”¨ç°æœ‰è¿æ¥
            return self.asr_pool[0]
```

### 7.2 è§†è§‰æŸ¥è¯¢ä¼˜åŒ–

```python
# æœ€ä½³å®è·µ2: å›¾åƒç¼“å­˜
class ImageCache:
    """å›¾åƒç¼“å­˜ç®¡ç†"""

    def __init__(self, max_size=10):
        self.cache = {}
        self.max_size = max_size
        self.access_order = []

    def add(self, image_id, image_data):
        """æ·»åŠ å›¾åƒåˆ°ç¼“å­˜"""
        if len(self.cache) >= self.max_size:
            # LRUæ·˜æ±°
            oldest = self.access_order.pop(0)
            del self.cache[oldest]

        self.cache[image_id] = image_data
        self.access_order.append(image_id)
```

### 7.3 å¤šæ¨¡æ€ä¸Šä¸‹æ–‡ç®¡ç†

```python
# æœ€ä½³å®è·µ3: ä¸Šä¸‹æ–‡çª—å£
class MultimodalContext:
    """å¤šæ¨¡æ€ä¸Šä¸‹æ–‡ç®¡ç†"""

    def __init__(self, window_size=5):
        self.history = []
        self.window_size = window_size

    def add_turn(self, user_input, system_response, modality):
        """æ·»åŠ å¯¹è¯è½®æ¬¡"""
        self.history.append({
            "user": user_input,
            "assistant": system_response,
            "modality": modality,  # "voice", "vision", "multimodal"
            "timestamp": time.time()
        })

        # ç»´æŠ¤çª—å£å¤§å°
        if len(self.history) > self.window_size:
            self.history.pop(0)
```

---

## 8. å‚è€ƒèµ„æ–™

### 8.1 å®˜æ–¹æ–‡æ¡£

- [é˜¿é‡Œäº‘NLS WebSocket SDKæ–‡æ¡£](https://help.aliyun.com/document_detail/120727.html)
- [Qwen-VL APIæ–‡æ¡£](https://help.aliyun.com/zh/dashscope/developer-reference/qwen-vl-api)
- [ROS2 Humbleæ–‡æ¡£](https://docs.ros.org/en/humble/index.html)

### 8.2 é¡¹ç›®å†…éƒ¨æ–‡æ¡£

- [ASRæœåŠ¡æŠ€æœ¯è§„æ ¼](./asr-service-technical-specification.md)
- [TTSæœåŠ¡æŠ€æœ¯è§„æ ¼](./tts-service-technical-specification.md)
- [é˜¿é‡Œäº‘NLS WebSocketè¿æ¥æŒ‡å—](./aliyun-nls-websocket-connection-guide.md)
- [ä¸»ç³»ç»Ÿæ¶æ„æ–‡æ¡£](./xlerobot-system-architecture-dataflow.md)

---

**æ–‡æ¡£ç»“æŸ**
**æœ€åæ›´æ–°**: 2025-11-16
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
