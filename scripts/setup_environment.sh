#!/bin/bash
# XleRobot Epic 1 ç¯å¢ƒå˜é‡è®¾ç½®è„šæœ¬
# ==================================
#
# æ­¤è„šæœ¬ç”¨äºè®¾ç½®XleRobot Epic 1æœåŠ¡æ‰€éœ€çš„ç¯å¢ƒå˜é‡
# å¯ä»¥é€‰æ‹©ä¸´æ—¶è®¾ç½®æˆ–æ°¸ä¹…è®¾ç½®åˆ°shellé…ç½®æ–‡ä»¶
#
# ä½œè€…: Dev Agent
# åˆ›å»ºæ—¶é—´: 2025-11-13

set -e

# ============================================
# ğŸ›¡ï¸ åŠ è½½XLeRobotä¸“ç”¨ç¯å¢ƒé…ç½®
# ============================================
# åŠ è½½ç¯å¢ƒè„šæœ¬ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„Pythonç¯å¢ƒ
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
if [[ -f "$SCRIPT_DIR/xlerobot_env.sh" ]]; then
    source "$SCRIPT_DIR/xlerobot_env.sh"
    echo "âœ… XLeRobotç¯å¢ƒå·²åŠ è½½"
else
    echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°xlerobot_env.shç¯å¢ƒè„šæœ¬"
    echo "è¯·ç¡®ä¿åœ¨XLeRoboté¡¹ç›®æ ¹ç›®å½•ä¸­è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é…ç½®
PROJECT_ROOT="/home/sunrise/xlerobot"
ENV_FILE="$PROJECT_ROOT/.env"
BACKUP_DIR="$PROJECT_ROOT/backups"

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    cat << EOF
XleRobot Epic 1 ç¯å¢ƒå˜é‡è®¾ç½®è„šæœ¬

ç”¨æ³•: $0 [é€‰é¡¹]

é€‰é¡¹:
    -h, --help      æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
    -t, --temp      ä¸´æ—¶è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå½“å‰ä¼šè¯ï¼‰
    -p, --permanent æ°¸ä¹…è®¾ç½®åˆ°shellé…ç½®æ–‡ä»¶
    -f, --file      ä»æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡
    -s, --show      æ˜¾ç¤ºå½“å‰ç¯å¢ƒå˜é‡çŠ¶æ€
    -c, --check     æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
    -r, --reset     é‡ç½®æ‰€æœ‰ç¯å¢ƒå˜é‡

ç¯å¢ƒå˜é‡è¯´æ˜:
    ALIBABA_CLOUD_ACCESS_KEY_ID     é˜¿é‡Œäº‘è®¿é—®å¯†é’¥ID
    ALIBABA_CLOUD_ACCESS_KEY_SECRET é˜¿é‡Œäº‘è®¿é—®å¯†é’¥Secret
    ALIYUN_NLS_APPKEY               é˜¿é‡Œäº‘è¯­éŸ³æœåŠ¡AppKey
    PYTHONPATH                      Pythonæ¨¡å—è·¯å¾„
    ROS_DOMAIN_ID                   ROS2åŸŸID

ç¤ºä¾‹:
    $0 --temp       # ä¸´æ—¶è®¾ç½®ï¼ˆæ¨èæµ‹è¯•ä½¿ç”¨ï¼‰
    $0 --permanent  # æ°¸ä¹…è®¾ç½®ï¼ˆæ¨èç”Ÿäº§ä½¿ç”¨ï¼‰
    $0 --show       # æ˜¾ç¤ºå½“å‰é…ç½®
    $0 --check      # æ£€æŸ¥é…ç½®

EOF
}

# åˆ›å»ºå¤‡ä»½
create_backup() {
    local backup_file="$BACKUP_DIR/env_backup_$(date +%Y%m%d_%H%M%S).sh"
    mkdir -p "$BACKUP_DIR"

    # å¤‡ä»½å½“å‰ç¯å¢ƒå˜é‡
    {
        echo "# XleRobotç¯å¢ƒå˜é‡å¤‡ä»½ - $(date)"
        echo "# Generated by setup_environment.sh"
        echo ""

        # å¤‡ä»½å·²è®¾ç½®çš„ç¯å¢ƒå˜é‡
        if [ -n "$ALIBABA_CLOUD_ACCESS_KEY_ID" ]; then
            echo "export ALIBABA_CLOUD_ACCESS_KEY_ID='$ALIBABA_CLOUD_ACCESS_KEY_ID'"
        fi
        if [ -n "$ALIBABA_CLOUD_ACCESS_KEY_SECRET" ]; then
            echo "export ALIBABA_CLOUD_ACCESS_KEY_SECRET='$ALIBABA_CLOUD_ACCESS_KEY_SECRET'"
        fi
        if [ -n "$ALIYUN_NLS_APPKEY" ]; then
            echo "export ALIYUN_NLS_APPKEY='$ALIYUN_NLS_APPKEY'"
        fi
        if [ -n "$PYTHONPATH" ]; then
            echo "export PYTHONPATH='$PYTHONPATH'"
        fi
        if [ -n "$ROS_DOMAIN_ID" ]; then
            echo "export ROS_DOMAIN_ID='$ROS_DOMAIN_ID'"
        fi
    } > "$backup_file"

    log_success "å¤‡ä»½å·²åˆ›å»º: $backup_file"
}

# ä¸´æ—¶è®¾ç½®ç¯å¢ƒå˜é‡
set_temp_env() {
    log_info "ğŸ”§ ä¸´æ—¶è®¾ç½®ç¯å¢ƒå˜é‡..."

    # è®¾ç½®é˜¿é‡Œäº‘è®¤è¯ä¿¡æ¯
    if [ -z "$ALIBABA_CLOUD_ACCESS_KEY_ID" ]; then
        read -p "è¯·è¾“å…¥é˜¿é‡Œäº‘Access Key ID: " access_key_id
        if [ -n "$access_key_id" ]; then
            export ALIBABA_CLOUD_ACCESS_KEY_ID="$access_key_id"
            log_success "âœ… ALIBABA_CLOUD_ACCESS_KEY_ID å·²è®¾ç½®"
        fi
    else
        log_success "âœ… ALIBABA_CLOUD_ACCESS_KEY_ID å·²å­˜åœ¨"
    fi

    if [ -z "$ALIBABA_CLOUD_ACCESS_KEY_SECRET" ]; then
        read -s -p "è¯·è¾“å…¥é˜¿é‡Œäº‘Access Key Secret: " access_key_secret
        echo  # æ¢è¡Œ
        if [ -n "$access_key_secret" ]; then
            export ALIBABA_CLOUD_ACCESS_KEY_SECRET="$access_key_secret"
            log_success "âœ… ALIBABA_CLOUD_ACCESS_KEY_SECRET å·²è®¾ç½®"
        fi
    else
        log_success "âœ… ALIBABA_CLOUD_ACCESS_KEY_SECRET å·²å­˜åœ¨"
    fi

    if [ -z "$ALIYUN_NLS_APPKEY" ]; then
        read -p "è¯·è¾“å…¥é˜¿é‡Œäº‘NLS AppKey (é»˜è®¤: YOUR_NLS_APPKEY): " appkey
        appkey=${appkey:-"YOUR_NLS_APPKEY"}
        if [ -n "$appkey" ]; then
            export ALIYUN_NLS_APPKEY="$appkey"
            log_success "âœ… ALIYUN_NLS_APPKEY å·²è®¾ç½®"
        fi
    else
        log_success "âœ… ALIYUN_NLS_APPKEY å·²å­˜åœ¨"
    fi

    # è®¾ç½®Pythonè·¯å¾„
    if [ -z "$PYTHONPATH" ]; then
        export PYTHONPATH="$PROJECT_ROOT/src:$PYTHONPATH"
        log_success "âœ… PYTHONPATH å·²è®¾ç½®"
    else
        if [[ "$PYTHONPATH" != *"$PROJECT_ROOT/src"* ]]; then
            export PYTHONPATH="$PROJECT_ROOT/src:$PYTHONPATH"
            log_success "âœ… PYTHONPATH å·²æ›´æ–°"
        else
            log_success "âœ… PYTHONPATH å·²å­˜åœ¨"
        fi
    fi

    # è®¾ç½®ROSåŸŸID
    if [ -z "$ROS_DOMAIN_ID" ]; then
        export ROS_DOMAIN_ID="42"
        log_success "âœ… ROS_DOMAIN_ID å·²è®¾ç½®"
    else
        log_success "âœ… ROS_DOMAIN_ID å·²å­˜åœ¨"
    fi

    log_success "ğŸ‰ ä¸´æ—¶ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆï¼"
    log_info "âš ï¸ æ³¨æ„: è¿™äº›ç¯å¢ƒå˜é‡ä»…åœ¨å½“å‰ä¼šè¯ä¸­æœ‰æ•ˆ"
    log_info "ğŸ’¡ æç¤º: ä½¿ç”¨ '$0 --permanent' æ°¸ä¹…è®¾ç½®"
}

# æ°¸ä¹…è®¾ç½®ç¯å¢ƒå˜é‡
set_permanent_env() {
    log_info "ğŸ”§ æ°¸ä¹…è®¾ç½®ç¯å¢ƒå˜é‡..."

    # ç¡®å®šshellé…ç½®æ–‡ä»¶
    local shell_rc=""
    if [ -n "$ZSH_VERSION" ]; then
        shell_rc="$HOME/.zshrc"
    elif [ -n "$BASH_VERSION" ]; then
        shell_rc="$HOME/.bashrc"
    else
        shell_rc="$HOME/.profile"
    fi

    log_info "æ£€æµ‹åˆ°shellé…ç½®æ–‡ä»¶: $shell_rc"

    # åˆ›å»ºå¤‡ä»½
    if [ -f "$shell_rc" ]; then
        cp "$shell_rc" "$shell_rc.backup.$(date +%Y%m%d_%H%M%S)"
        log_success "å·²å¤‡ä»½åŸé…ç½®æ–‡ä»¶"
    fi

    # æ£€æŸ¥æ˜¯å¦å·²æœ‰XleRobotç¯å¢ƒå˜é‡éƒ¨åˆ†
    local temp_file=$(mktemp)
    if grep -q "# XleRobot Epic 1 Environment Variables" "$shell_rc" 2>/dev/null; then
        log_info "æ£€æµ‹åˆ°ç°æœ‰XleRoboté…ç½®ï¼Œå°†æ›´æ–°..."
        # åˆ é™¤æ—§çš„éƒ¨åˆ†
        awk '
            BEGIN { skip = 0 }
            /# XleRobot Epic 1 Environment Variables/ { skip = 1 }
            skip && /^$/ { skip = 0; next }
            !skip { print }
        ' "$shell_rc" > "$temp_file"
    else
        cp "$shell_rc" "$temp_file" 2>/dev/null || touch "$temp_file"
    fi

    # æ·»åŠ æ–°çš„ç¯å¢ƒå˜é‡éƒ¨åˆ†
    cat >> "$temp_file" << 'EOF'

# XleRobot Epic 1 Environment Variables
# Generated by setup_environment.sh
if [ -f "/home/sunrise/xlerobot/.env" ]; then
    set -a
    source /home/sunrise/xlerobot/.env
    set +a
fi

# Set default values if not set in .env
export ALIBABA_CLOUD_ACCESS_KEY_ID="${ALIBABA_CLOUD_ACCESS_KEY_ID:-}"
export ALIBABA_CLOUD_ACCESS_KEY_SECRET="${ALIBABA_CLOUD_ACCESS_KEY_SECRET:-}"
export ALIYUN_NLS_APPKEY="${ALIYUN_NLS_APPKEY:-YOUR_NLS_APPKEY}"
export PYTHONPATH="${PYTHONPATH:-/home/sunrise/xlerobot/src}"
export ROS_DOMAIN_ID="${ROS_DOMAIN_ID:-42}"
EOF

    # åº”ç”¨é…ç½®
    mv "$temp_file" "$shell_rc"

    # åˆ›å»º.envæ–‡ä»¶æ¨¡æ¿
    create_env_file

    log_success "âœ… æ°¸ä¹…ç¯å¢ƒå˜é‡é…ç½®å®Œæˆï¼"
    log_info "ğŸ“ é…ç½®å·²å†™å…¥: $shell_rc"
    log_info "ğŸ”§ è¯·è¿è¡Œ 'source $shell_rc' æˆ–é‡æ–°æ‰“å¼€ç»ˆç«¯ä»¥ä½¿é…ç½®ç”Ÿæ•ˆ"
}

# åˆ›å»º.envæ–‡ä»¶
create_env_file() {
    log_info "ğŸ“ åˆ›å»º.envæ–‡ä»¶æ¨¡æ¿..."

    cat > "$ENV_FILE" << 'EOF'
# XleRobot Epic 1 ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶
# è¯·å¡«å…¥æ‚¨çš„å®é™…é…ç½®ä¿¡æ¯
# æ³¨æ„: è¯·ä¸è¦å°†æ­¤æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ

# é˜¿é‡Œäº‘è®¿é—®å¯†é’¥ (å¿…å¡«)
ALIBABA_CLOUD_ACCESS_KEY_ID=
ALIBABA_CLOUD_ACCESS_KEY_SECRET=

# é˜¿é‡Œäº‘è¯­éŸ³æœåŠ¡AppKey (å·²æä¾›é»˜è®¤å€¼)
ALIYUN_NLS_APPKEY=YOUR_NLS_APPKEY

# å…¶ä»–é…ç½® (é€šå¸¸ä¸éœ€è¦ä¿®æ”¹)
PYTHONPATH=/home/sunrise/xlerobot/src
ROS_DOMAIN_ID=42
EOF

    log_success "âœ… .envæ–‡ä»¶æ¨¡æ¿å·²åˆ›å»º: $ENV_FILE"
    log_warning "âš ï¸ è¯·ç¼–è¾‘ $ENV_FILE æ–‡ä»¶ï¼Œå¡«å…¥æ‚¨çš„é˜¿é‡Œäº‘è®¿é—®å¯†é’¥"
}

# æ˜¾ç¤ºå½“å‰ç¯å¢ƒå˜é‡
show_env_status() {
    log_info "ğŸ“Š å½“å‰ç¯å¢ƒå˜é‡çŠ¶æ€:"
    echo "=================================="

    # æ£€æŸ¥æ¯ä¸ªç¯å¢ƒå˜é‡
    local vars=(
        "ALIBABA_CLOUD_ACCESS_KEY_ID:é˜¿é‡Œäº‘è®¿é—®å¯†é’¥ID"
        "ALIBABA_CLOUD_ACCESS_KEY_SECRET:é˜¿é‡Œäº‘è®¿é—®å¯†é’¥Secret"
        "ALIYUN_NLS_APPKEY:é˜¿é‡Œäº‘è¯­éŸ³æœåŠ¡AppKey"
        "PYTHONPATH:Pythonæ¨¡å—è·¯å¾„"
        "ROS_DOMAIN_ID:ROS2åŸŸID"
    )

    for var_info in "${vars[@]}"; do
        local var_name=$(echo "$var_info" | cut -d':' -f1)
        local var_desc=$(echo "$var_info" | cut -d':' -f2)
        local var_value="${!var_name}"

        if [ -n "$var_value" ]; then
            if [[ "$var_name" == *"KEY"* ]] || [[ "$var_name" == *"SECRET"* ]]; then
                # æ•æ„Ÿä¿¡æ¯ï¼Œåªæ˜¾ç¤ºå‰å‡ ä½
                local display_value="${var_value:0:10}..."
            else
                local display_value="$var_value"
            fi
            log_success "âœ… $var_name: $display_value"
        else
            log_warning "âš ï¸ $var_name: æœªè®¾ç½®"
        fi
    done

    echo "=================================="

    # æ£€æŸ¥.envæ–‡ä»¶
    if [ -f "$ENV_FILE" ]; then
        log_info "ğŸ“ .envæ–‡ä»¶å­˜åœ¨"
        if [ -s "$ENV_FILE" ]; then
            local filled_vars=$(grep -v "^#" "$ENV_FILE" | grep -v "^$" | grep -c "=" || true)
            log_info "ğŸ“ .envæ–‡ä»¶ä¸­æœ‰ $filled_vars ä¸ªå˜é‡é…ç½®"
        else
            log_warning "âš ï¸ .envæ–‡ä»¶ä¸ºç©º"
        fi
    else
        log_warning "âš ï¸ .envæ–‡ä»¶ä¸å­˜åœ¨"
    fi
}

# æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
check_env_config() {
    log_info "ğŸ” æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®..."

    local errors=0
    local warnings=0

    # æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
    if [ -z "$ALIBABA_CLOUD_ACCESS_KEY_ID" ]; then
        log_error "âŒ ALIBABA_CLOUD_ACCESS_KEY_ID æœªè®¾ç½®"
        ((errors++))
    else
        log_success "âœ… ALIBABA_CLOUD_ACCESS_KEY_ID å·²è®¾ç½®"
    fi

    if [ -z "$ALIBABA_CLOUD_ACCESS_KEY_SECRET" ]; then
        log_error "âŒ ALIBABA_CLOUD_ACCESS_KEY_SECRET æœªè®¾ç½®"
        ((errors++))
    else
        log_success "âœ… ALIBABA_CLOUD_ACCESS_KEY_SECRET å·²è®¾ç½®"
    fi

    if [ -z "$ALIYUN_NLS_APPKEY" ]; then
        log_warning "âš ï¸ ALIYUN_NLS_APPKEY æœªè®¾ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼"
        ((warnings++))
    else
        log_success "âœ… ALIYUN_NLS_APPKEY å·²è®¾ç½®"
    fi

    # æ£€æŸ¥å¯é€‰çš„ç¯å¢ƒå˜é‡
    if [ -z "$PYTHONPATH" ]; then
        log_warning "âš ï¸ PYTHONPATH æœªè®¾ç½®ï¼Œå¯èƒ½å½±å“æ¨¡å—å¯¼å…¥"
        ((warnings++))
    else
        if [[ "$PYTHONPATH" == *"$PROJECT_ROOT/src"* ]]; then
            log_success "âœ… PYTHONPATH æ­£ç¡®é…ç½®"
        else
            log_warning "âš ï¸ PYTHONPATH å¯èƒ½æœªåŒ…å«é¡¹ç›®è·¯å¾„"
            ((warnings++))
        fi
    fi

    if [ -z "$ROS_DOMAIN_ID" ]; then
        log_warning "âš ï¸ ROS_DOMAIN_ID æœªè®¾ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼"
        ((warnings++))
    else
        log_success "âœ… ROS_DOMAIN_ID å·²è®¾ç½®"
    fi

    # æ€»ç»“
    echo "=================================="
    if [ $errors -gt 0 ]; then
        log_error "âŒ é…ç½®æ£€æŸ¥å¤±è´¥: $errors ä¸ªé”™è¯¯ï¼Œ$warnings ä¸ªè­¦å‘Š"
        log_info "è¯·ä½¿ç”¨ '$0 --temp' æˆ– '$0 --permanent' è®¾ç½®ç¼ºå¤±çš„ç¯å¢ƒå˜é‡"
        return 1
    elif [ $warnings -gt 0 ]; then
        log_warning "âš ï¸ é…ç½®åŸºæœ¬æ­£å¸¸: $warnings ä¸ªè­¦å‘Š"
        log_info "å»ºè®®è§£å†³è­¦å‘Šé—®é¢˜ä»¥è·å¾—æœ€ä½³ä½“éªŒ"
        return 0
    else
        log_success "ğŸ‰ é…ç½®æ£€æŸ¥å®Œå…¨é€šè¿‡ï¼"
        return 0
    fi
}

# é‡ç½®ç¯å¢ƒå˜é‡
reset_env() {
    log_warning "âš ï¸ é‡ç½®æ‰€æœ‰XleRobotç›¸å…³ç¯å¢ƒå˜é‡..."

    # åˆ›å»ºå¤‡ä»½
    create_backup

    # æ¸…ç†å½“å‰ç¯å¢ƒå˜é‡
    unset ALIBABA_CLOUD_ACCESS_KEY_ID
    unset ALIBABA_CLOUD_ACCESS_KEY_SECRET
    unset ALIYUN_NLS_APPKEY
    unset ROS_DOMAIN_ID

    # æ¸…ç†PYTHONPATHä¸­çš„é¡¹ç›®è·¯å¾„
    if [ -n "$PYTHONPATH" ]; then
        export PYTHONPATH=$(echo "$PYTHONPATH" | sed "s|$PROJECT_ROOT/src:||g" | sed "s|:$PROJECT_ROOT/src||g")
    fi

    # åˆ é™¤.envæ–‡ä»¶
    if [ -f "$ENV_FILE" ]; then
        rm -f "$ENV_FILE"
        log_info "å·²åˆ é™¤ .env æ–‡ä»¶"
    fi

    # æ¸…ç†shellé…ç½®æ–‡ä»¶ä¸­çš„XleRoboté…ç½®
    local shell_rc=""
    if [ -n "$ZSH_VERSION" ]; then
        shell_rc="$HOME/.zshrc"
    elif [ -n "$BASH_VERSION" ]; then
        shell_rc="$HOME/.bashrc"
    else
        shell_rc="$HOME/.profile"
    fi

    if [ -f "$shell_rc" ]; then
        local temp_file=$(mktemp)
        awk '
            BEGIN { skip = 0 }
            /# XleRobot Epic 1 Environment Variables/ { skip = 1 }
            skip && /^$/ { skip = 0; next }
            !skip { print }
        ' "$shell_rc" > "$temp_file"
        mv "$temp_file" "$shell_rc"
        log_info "å·²æ¸…ç† shell é…ç½®æ–‡ä»¶"
    fi

    log_success "âœ… ç¯å¢ƒå˜é‡é‡ç½®å®Œæˆ"
}

# ä¸»å‡½æ•°
main() {
    case "${1:-help}" in
        "temp"|"-t"|"--temp")
            set_temp_env
            ;;
        "permanent"|"-p"|"--permanent")
            set_permanent_env
            ;;
        "file"|"-f"|"--file")
            if [ -f "$ENV_FILE" ]; then
                log_info "ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡..."
                set -a
                source "$ENV_FILE"
                set +a
                log_success "âœ… ç¯å¢ƒå˜é‡å·²åŠ è½½"
            else
                log_error "âŒ .env æ–‡ä»¶ä¸å­˜åœ¨"
                exit 1
            fi
            ;;
        "show"|"-s"|"--show")
            show_env_status
            ;;
        "check"|"-c"|"--check")
            check_env_config
            ;;
        "reset"|"-r"|"--reset")
            reset_env
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        *)
            log_error "æœªçŸ¥é€‰é¡¹: $1"
            show_help
            exit 1
            ;;
    esac
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"